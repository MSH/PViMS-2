<div style="height: 5px;">
  <mat-progress-bar mode="indeterminate" color="primary" *ngIf="isBusy()"></mat-progress-bar>
</div>

<mat-card class="p-0">
  <mat-card-title class="">
    <div class="card-title-text">{{'PV Feedback' | translate}}</div>
  </mat-card-title>

  <mat-card-content>
    <form [formGroup]="viewModelForm">
      <div class="p-0 default-light-bg rounded">
        <mat-tab-group [(selectedIndex)]="viewModel.selectedTab">
          <mat-tab label="{{'New Feedback' | translate}}">
            <mat-card-content class="m-1 p-5" style="height: 130px;">
              <div fxLayout="row wrap" fxLayout.xs="column" fxLayoutGap="5.5%" fxLayoutAlign="start">
                <div fxFlex="100" class="pr-1">
                  <mat-chip-list #chipList>
                    <div *ngFor="let activity of viewModel?.workFlow?.feedbackActivity">
                      <mat-chip color="primary" [selected]="activity.qualifiedName == viewModelForm.get('qualifiedName').value" (click)="selectActivity(activity.qualifiedName)" *ngIf="activity.reportInstanceCount > 0"> 
                        {{activity.qualifiedName | translate}}
                      </mat-chip>
                      <span class="mr-24" matBadge="{{activity.reportInstanceCount}}" matBadgePosition="above after" matBadgeColor="warn" matBadgeOverlap="true" *ngIf="activity.reportInstanceCount > 0"></span>
                    </div>
                  </mat-chip-list>
                </div>
                <div fxFlex="100" class="pr-1" *ngIf="hasActivity() == false">
                  <div class="card-title-text light-gray p-24">
                    {{ 'There is currently no feedback' | translate }}
                  </div>
                </div>
                <div fxFlex="100" class="pr-1" *ngIf="viewModelForm.get('qualifiedName').value == 'Confirm Report Data'">
                  <div class="mat-color-primary rounded p-24">
                    {{ 'The following reports have outstanding data quality tasks that require additional follow up ...' | translate }}
                  </div>
                </div>
                <div fxFlex="100" class="pr-1" *ngIf="viewModelForm.get('qualifiedName').value == 'Set MedDRA and Causality'">
                  <div class="mat-color-primary rounded p-24">
                    {{ 'The MedDRA and Causality stage for the following reports has been completed ...' | translate }}
                  </div>
                </div>
                <div fxFlex="100" class="pr-1" *ngIf="viewModelForm.get('qualifiedName').value == 'Extract E2B'">
                  <div class="mat-color-primary rounded p-24">
                    {{ 'The following reports have been submitted for E2B processing ...' | translate }}
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-tab>

          <mat-tab label="{{'Search by term' | translate}}">
            <mat-card-content class="m-1 p-5" style="height: 130px;">
              <div fxLayout="row wrap" fxLayout.xs="column" fxLayoutGap="0.1%" fxLayoutAlign="start">
                <div fxFlex="100" class="pr-1 p-12">
                  <mat-label>{{'Please enter a term below to search by patient name, MedDra term as set by the clinician, the MedDra term as set by the PV specialist, the report identifier or medications used in the analysis' | translate}}...</mat-label>
                </div>
                <div fxFlex="50" class="pr-1">
                  <mat-form-field class="p-8 full-width">
                    <input matInput formControlName="searchTerm" placeholder="{{'Term' | translate}}">
                  </mat-form-field>
                </div>
              </div>
              <div fxLayout="row" fxLayout.xs="column" fxLayoutGap="10" fxLayoutAlign="end" class="p-8">
                <button mat-raised-button color="primary" (click)="searchByTerm()" [disabled]="viewModelForm.invalid">{{'Search' | translate}}</button>
              </div>
            </mat-card-content>
          </mat-tab>
        </mat-tab-group>
      </div>
    </form>

    <div class="ml-05 mr-05 mt-05 pb-1">
      <div class="table-container">
        <mat-table [dataSource]="viewModel?.mainGrid?.records"
                    [@animate]="{value:'50'}">

            <ng-container matColumnDef="Id">
              <mat-header-cell *matHeaderCellDef>Id</mat-header-cell>
              <mat-cell *matCellDef="let record">
                  <p>{{record.id}}</p>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="identifier">
              <mat-header-cell *matHeaderCellDef>{{ 'Identifier' | translate }}</mat-header-cell>
              <mat-cell *matCellDef="let record">
                  <p>{{record.identifier}}</p>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="created">
                <mat-header-cell *matHeaderCellDef>{{ 'Created' | translate }}</mat-header-cell>
                <mat-cell *matCellDef="let record">
                    <p>{{record.createdDetail}}</p><br/>
                </mat-cell>
            </ng-container>

            <ng-container matColumnDef="patient">
              <mat-header-cell *matHeaderCellDef>{{ 'Patient' | translate }}</mat-header-cell>
              <mat-cell *matCellDef="let record">
                  <p>{{record.patientIdentifier}}</p>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="medication-summary">
                <mat-header-cell *matHeaderCellDef>{{ 'Medications' | translate }}</mat-header-cell>
                <mat-cell *matCellDef="let record">
                    <button mat-raised-button 
                            *ngIf="record.medications?.length > 0"
                            (click)="openMedicationPopUp(record.medications, {})">
                            {{"View" | translate }}
                    </button>
                </mat-cell>
            </ng-container>

            <ng-container matColumnDef="adverse-event">
              <mat-header-cell *matHeaderCellDef>{{ 'Adverse event' | translate }}</mat-header-cell>
              <mat-cell *matCellDef="let record">
                  <p>{{record.sourceIdentifier}}</p>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="meddra-term">
              <mat-header-cell *matHeaderCellDef>{{ 'MedDra term' | translate }}</mat-header-cell>
              <mat-cell *matCellDef="let record">
                  <p>{{record.terminologyMedDra?.medDraTerm}}</p>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="task-count">
              <mat-header-cell *matHeaderCellDef>{{ 'Tasks' | translate }}</mat-header-cell>
              <mat-cell *matCellDef="let record">
                  <div class="text-center pt-12 pb-12 border-right-light">
                    <mat-icon matBadge="{{record.taskCount}}" matBadgeOverlap="false" *ngIf="record.activeTaskCount == 0" matBadgeColor="accent">assignment</mat-icon>
                    <mat-icon matBadge="{{record.taskCount}}" matBadgeOverlap="false" *ngIf="record.activeTaskCount > 0" matBadgeColor="warn">assignment</mat-icon>
                  </div>                
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="status">
              <mat-header-cell *matHeaderCellDef>{{ 'Status' | translate }}</mat-header-cell>
              <mat-cell *matCellDef="let record">
                  <p>{{record.qualifiedName | translate}} | {{record.currentStatus | translate}}</p>
              </mat-cell>
            </ng-container>                

            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>{{'Actions' | translate}}</mat-header-cell>
              <mat-cell *matCellDef="let record">
                <button mat-icon-button color="primary" matTooltip="{{'View Adverse Event' | translate}}"
                        (click)="openClinicalEventTaskPopUp(record)">
                  <mat-icon>visibility</mat-icon>
                </button>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="viewModel?.mainGrid?.displayedColumns; sticky:true"></mat-header-row>
            <mat-row *matRowDef="let record; columns: viewModel?.mainGrid?.displayedColumns;"></mat-row>
        </mat-table>
      </div>

      <mat-paginator #mainGridPaginator="matPaginator" [length]="viewModel?.mainGrid?.count"
                    [pageIndex]="0" [pageSize]="10"
                    [pageSizeOptions]="[5, 10, 25, 50]">
      </mat-paginator>
    </div>
  </mat-card-content>
</mat-card>