-- ***************** METAREPORTS
INSERT INTO MetaReport (metareport_guid, ReportName, ReportDefinition, MetaDefinition, Breadcrumb, SQLDefinition, IsSystem, ReportStatus) 
	SELECT NEWID(), 'Patients on Treatment' As ReportName, 'Patients on Treatment', '** NOT DEFINED **', '** NOT DEFINED **', 'SELECT f.FacilityName, f.Id as FacilityId,	(select count(distinct(ip.Id)) from Encounter ie inner join Patient ip on ie.Patient_Id = ip.Id inner join PatientFacility ipf on ip.Id = ipf.Patient_Id AND ipf.EnrolledDate = (select MAX(EnrolledDate) FROM PatientFacility iipf WHERE iipf.Patient_Id = ip.Id) inner join Facility ifa on ipf.Facility_Id = ifa.Id where ie.EncounterDate between ''{0}'' and ''{1}'' and ifa.Id = f.Id) AS PatientCount,	(select count(distinct(ip.Id)) from Encounter ie inner join Patient ip on ie.Patient_Id = ip.Id inner join PatientFacility ipf on ip.Id = ipf.Patient_Id AND ipf.EnrolledDate = (select MAX(EnrolledDate) FROM PatientFacility iipf WHERE iipf.Patient_Id = ip.Id) inner join Facility ifa on ipf.Facility_Id = ifa.Id inner join PatientClinicalEvent ipce on ip.Id = ipce.Patient_Id where ie.EncounterDate between ''{0}'' and ''{1}'' and ifa.Id = f.Id) AS PatientWithEventCount FROM Facility f ORDER BY f.FacilityName ', 1, 1
		UNION SELECT NEWID(), 'Adverse Events', 'Adverse Events', '** NOT DEFINED **', '** NOT DEFINED **', 'SELECT t.MedDraTerm + ''('' + [MedDraCode] + '')'' AS ''Description'', CASE WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) < 5844 THEN ''<16'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 5844 AND 9131 THEN ''Between 16 and 25'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 9132 AND 12784 THEN ''Between 26 and 35'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 12785 AND 16436 THEN ''Between 36 and 45'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 16437 AND 20089 THEN ''Between 46 and 55'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) > 20089 THEN ''>55'' END AS ''Criteria'', COUNT(*) AS PatientCount FROM PatientClinicalEvent pce INNER JOIN Patient p ON pce.Patient_Id = p.Id INNER JOIN TerminologyMedDra t ON pce.SourceTerminologyMedDra_Id = t.Id WHERE pce.OnsetDate BETWEEN ''{0}'' AND ''{1}'' GROUP BY t.MedDraTerm + ''('' + [MedDraCode] + '')'', CASE WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) < 5844 THEN ''<16'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 5844 AND 9131 THEN ''Between 16 and 25'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 9132 AND 12784 THEN ''Between 26 and 35'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 12785 AND 16436 THEN ''Between 36 and 45'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 16437 AND 20089 THEN ''Between 46 and 55'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) > 20089 THEN ''>55'' END ORDER BY t.MedDraTerm + ''('' + [MedDraCode] + '')'' asc, Criteria asc', 1, 1
		UNION SELECT NEWID(), 'Quarterly Adverse Events', 'Quarterly Adverse Events', '** NOT DEFINED **', '** NOT DEFINED **', 'SELECT t.MedDraTerm + ''('' + [MedDraCode] + '')'' AS ''Description'', CASE WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) < 5844 THEN ''<16'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 5844 AND 9131 THEN ''Between 16 and 25'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 9132 AND 12784 THEN ''Between 26 and 35'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 12785 AND 16436 THEN ''Between 36 and 45'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 16437 AND 20089 THEN ''Between 46 and 55'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) > 20089 THEN ''>55'' END AS ''Criteria'', COUNT(*) AS PatientCount FROM PatientClinicalEvent pce INNER JOIN Patient p ON pce.Patient_Id = p.Id INNER JOIN TerminologyMedDra t ON pce.SourceTerminologyMedDra_Id = t.Id WHERE pce.OnsetDate BETWEEN ''{0}'' AND ''{1}'' GROUP BY t.MedDraTerm + ''('' + [MedDraCode] + '')'', CASE WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) < 5844 THEN ''<16'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 5844 AND 9131 THEN ''Between 16 and 25'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 9132 AND 12784 THEN ''Between 26 and 35'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 12785 AND 16436 THEN ''Between 36 and 45'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 16437 AND 20089 THEN ''Between 46 and 55'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) > 20089 THEN ''>55'' END ORDER BY t.MedDraTerm + ''('' + [MedDraCode] + '')'' asc, Criteria asc', 1, 1
		UNION SELECT NEWID(), 'Annual Adverse Events', 'Annual Adverse Events', '** NOT DEFINED **', '** NOT DEFINED **', 'SELECT t.MedDraTerm + ''('' + [MedDraCode] + '')'' AS ''Description'', CASE WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) < 5844 THEN ''<16'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 5844 AND 9131 THEN ''Between 16 and 25'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 9132 AND 12784 THEN ''Between 26 and 35'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 12785 AND 16436 THEN ''Between 36 and 45'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 16437 AND 20089 THEN ''Between 46 and 55'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) > 20089 THEN ''>55'' END AS ''Criteria'', COUNT(*) AS PatientCount FROM PatientClinicalEvent pce INNER JOIN Patient p ON pce.Patient_Id = p.Id INNER JOIN TerminologyMedDra t ON pce.SourceTerminologyMedDra_Id = t.Id WHERE pce.OnsetDate BETWEEN ''{0}'' AND ''{1}'' GROUP BY t.MedDraTerm + ''('' + [MedDraCode] + '')'', CASE WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) < 5844 THEN ''<16'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 5844 AND 9131 THEN ''Between 16 and 25'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 9132 AND 12784 THEN ''Between 26 and 35'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 12785 AND 16436 THEN ''Between 36 and 45'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) BETWEEN 16437 AND 20089 THEN ''Between 46 and 55'' WHEN DATEDIFF(dd, p.DateOfBirth, GETDATE()) > 20089 THEN ''>55'' END ORDER BY t.MedDraTerm + ''('' + [MedDraCode] + '')'' asc, Criteria asc', 1, 1
		UNION SELECT NEWID(), 'Causality', 'Causality status', '** NOT DEFINED **', '** NOT DEFINED **', 'SELECT p.Id AS Patient_Id, p.FirstName, p.Surname, t.MedDraTerm + ''('' + [MedDraCode] + '')'' AS AdverseEvent, pce.OnsetDate, mc.NaranjoCausality, mc.WhoCausality FROM Patient p INNER JOIN PatientClinicalEvent pce ON p.Id = pce.Patient_Id INNER JOIN TerminologyMedDra t ON pce.SourceTerminologyMedDra_Id = t.Id INNER JOIN MedicationCausality mc ON pce.Id = mc.ClinicalEvent_Id WHERE pce.OnsetDate BETWEEN ''{0}'' AND ''{1}'' AND (mc.NaranjoCausality IS NULL OR mc.WhoCausality IS NULL) ORDER BY pce.OnsetDate asc ', 1, 1
		UNION SELECT NEWID(), 'Patients by Drug', 'Patients by Drug', '** NOT DEFINED **', '** NOT DEFINED **', 'SELECT m.DrugName, m.Id as MedicationId,	(select count(distinct(ip.Id)) from Patient ip inner join PatientMedication ipm on ip.Id = ipm.Patient_Id inner join Medication im on ipm.Medication_Id = im.Id where im.Id = m.Id) AS PatientCount FROM Medication m ORDER BY m.DrugName ', 1, 1
		UNION SELECT NEWID(), 'Outstanding Visits', 'Outstanding Visits', '** NOT DEFINED **', '** NOT DEFINED **', 'SELECT p.Id AS Patient_Id, p.FirstName, p.Surname, a.AppointmentDate FROM Patient p INNER JOIN Appointment a ON p.Id = a.Patient_Id WHERE a.AppointmentDate < DATEADD(dd, 3, GETDATE()) AND a.AppointmentDate BETWEEN ''{0}'' AND ''{1}'' AND a.Cancelled = 0 AND NOT EXISTS(SELECT Id FROM Encounter ie WHERE ie.Patient_Id = p.Id AND ie.EncounterDate BETWEEN DATEADD(dd, -3, a.AppointmentDate) AND DATEADD(dd, 3, a.AppointmentDate)) ORDER BY a.AppointmentDate desc', 1, 1
	ORDER BY ReportName	
	